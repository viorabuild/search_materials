<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction AI Agent - –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .tab-active {
            background-color: #ebf5ff;
            color: #1d4ed8;
            border-color: #1d4ed8;
        }
        .result-box {
            @apply bg-gray-50 border border-gray-200 rounded-lg p-4 mt-4;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-3xl font-bold flex items-center">
                    <i class="fas fa-robot mr-3"></i>
                    Construction AI Agent
                </h1>
                <p class="text-blue-100 mt-2">
                    üöÄ –ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Ä¢ üìä Google Sheets ‚Ä¢ üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ç ‚Ä¢ üåê –í–µ–±-–ø–æ–∏—Å–∫
                </p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="lg:flex">
                    <!-- Sidebar Tabs -->
                    <aside class="lg:w-64 border-b lg:border-b-0 lg:border-r border-gray-200">
                        <nav class="flex lg:flex-col overflow-x-auto lg:overflow-visible p-4 lg:p-6 gap-2">
                            <button
                                v-for="tab in tabs"
                                :key="tab.id"
                                @click="activeTab = tab.id"
                                :class="{'tab-active': activeTab === tab.id}"
                                class="flex items-center w-full px-4 py-3 text-left font-medium text-gray-700 rounded-lg border-l-4 border-transparent hover:bg-blue-50 transition-colors whitespace-nowrap"
                            >
                                <i :class="tab.icon" class="mr-3 w-5 text-gray-500"></i>
                                <span class="truncate">{{ tab.name }}</span>
                            </button>
                        </nav>
                    </aside>

                    <!-- Tab Content -->
                    <div class="p-6 flex-1">
                    <!-- Universal Command Tab -->
                    <div v-if="activeTab === 'universal'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üí¨ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                        </h2>
                        <p class="text-gray-600 mb-4">
                            –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–æ, –∏ –∞–≥–µ–Ω—Ç —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å!
                        </p>
                        
                        <div class="grid lg:grid-cols-3 gap-6">
                            <div class="space-y-4 lg:col-span-2">
                                <div class="space-y-4">
                                    <textarea
                                        v-model="universalCommand"
                                        class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="4"
                                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä:&#10;- –ù–∞–π–¥–∏ —Ü–µ–Ω—É –Ω–∞ —Ü–µ–º–µ–Ω—Ç –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏&#10;- –ü—Ä–æ—á–∏—Ç–∞–π —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–∫–∞–∂–∏ –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫&#10;- –ü—Ä–æ–≤–µ—Ä—å —Å–º–µ—Ç—É –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ&#10;- –ù–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –∫–µ—Ä–∞–º–∏—á–µ—Å–∫–æ–π –ø–ª–∏—Ç–∫–∏"
                                    ></textarea>
                                    
                                    <div class="flex items-center gap-3">
                                        <button
                                            @click="processUniversalCommand"
                                            :disabled="loading || !universalCommand.trim()"
                                            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É
                                        </button>
                                        <button
                                            v-if="historyActiveId"
                                            @click="historyActiveId = null"
                                            class="px-4 py-3 text-sm text-gray-600 hover:text-gray-900 transition-colors"
                                        >
                                            –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                                        </button>
                                    </div>
                                </div>

                                <div v-if="universalResult" class="result-box">
                                    <h3 class="font-bold text-lg mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                                    <div class="whitespace-pre-wrap" v-html="formatResult(universalResult)"></div>
                                </div>

                                <div
                                    v-if="sheetEmbedUrl && stats && stats.sheet"
                                    class="result-box"
                                >
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
                                        <div>
                                            <h3 class="font-bold text-lg text-gray-800">
                                                {{ stats.sheet.spreadsheet_title }}
                                            </h3>
                                            <p class="text-sm text-gray-600">
                                                –õ–∏—Å—Ç: {{ stats.sheet.worksheet }}
                                            </p>
                                        </div>
                                        <a
                                            :href="stats.sheet.worksheet_url"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            <i class="fas fa-external-link-alt mr-2"></i>
                                            –û—Ç–∫—Ä—ã—Ç—å –≤ Google Sheets
                                        </a>
                                    </div>
                                    <div class="overflow-hidden rounded-lg border border-gray-200">
                                        <iframe
                                            :src="sheetEmbedUrl"
                                            class="w-full"
                                            style="height: 480px;"
                                            frameborder="0"
                                            allowfullscreen
                                        ></iframe>
                                    </div>
                                    <p class="mt-2 text-xs text-gray-500">
                                        –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Google Sheets. –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.
                                    </p>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-white border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="font-bold text-lg text-gray-800">
                                            –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
                                        </h3>
                                        <button
                                            @click="clearHistory"
                                            :disabled="!universalHistory.length"
                                            class="text-sm text-gray-500 hover:text-red-600 disabled:text-gray-300 transition-colors"
                                        >
                                            –û—á–∏—Å—Ç–∏—Ç—å
                                        </button>
                                    </div>

                                    <p v-if="!universalHistory.length" class="text-sm text-gray-500">
                                        –ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥.
                                    </p>

                                    <div
                                        v-for="item in universalHistory"
                                        :key="item.id"
                                        class="mb-3 last:mb-0"
                                    >
                                        <button
                                            @click="loadHistoryEntry(item)"
                                            class="w-full text-left border border-transparent hover:border-blue-200 rounded-lg p-3 transition-colors"
                                            :class="{
                                                'bg-blue-50 border-blue-200 shadow-sm': historyActiveId === item.id,
                                                'bg-gray-50': historyActiveId !== item.id
                                            }"
                                        >
                                            <div class="flex items-center justify-between gap-2">
                                                <span
                                                    class="text-xs font-medium"
                                                    :class="item.success ? 'text-green-600' : 'text-red-600'"
                                                >
                                                    {{ item.success ? '–£—Å–ø–µ—Ö' : '–û—à–∏–±–∫–∞' }}
                                                </span>
                                                <span class="text-xs text-gray-500">
                                                    {{ formatTimestamp(item.timestamp) }}
                                                </span>
                                            </div>
                                            <p class="mt-2 text-sm text-gray-800 break-words whitespace-pre-line max-h-20 overflow-hidden">
                                                {{ item.command }}
                                            </p>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Project Chat Tab -->
                    <div v-if="activeTab === 'projectChat'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üß† –ê—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
                        </h2>
                        <p class="text-gray-600 mb-4">
                            –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ–± –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, —Ñ–∞–π–ª–∞—Ö –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç README –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.
                        </p>

                        <div class="grid lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-4">
                                <div class="bg-white border border-gray-200 rounded-lg shadow-sm h-96 flex flex-col">
                                    <div
                                        ref="projectChatScroll"
                                        class="flex-1 overflow-y-auto px-4 py-4 space-y-3"
                                    >
                                        <div
                                            v-if="!projectChatMessages.length"
                                            class="h-full flex flex-col items-center justify-center text-center text-gray-500"
                                        >
                                            <i class="fas fa-comments text-3xl mb-3 text-gray-400"></i>
                                            <p>–ß–∞—Ç –ø—É—Å—Ç. –ó–∞–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω ConstructionAIAgent¬ª.</p>
                                        </div>
                                        <div
                                            v-for="message in projectChatMessages"
                                            :key="message.id"
                                            class="flex"
                                            :class="{
                                                'justify-end': message.role === 'user',
                                                'justify-start': message.role !== 'user'
                                            }"
                                        >
                                            <div
                                                class="max-w-full sm:max-w-xl rounded-lg px-4 py-3 shadow-sm border"
                                                :class="{
                                                    'bg-blue-600 text-white border-blue-600': message.role === 'user',
                                                    'bg-gray-50 text-gray-900 border-gray-200': message.role === 'assistant',
                                                    'bg-yellow-50 text-gray-900 border-yellow-200': message.role === 'system'
                                                }"
                                            >
                                                <div class="text-xs font-semibold opacity-80 mb-1 flex items-center justify-between gap-3">
                                                    <span>{{ labelProjectChatRole(message.role) }}</span>
                                                    <span>{{ formatTimestamp(message.timestamp) }}</span>
                                                </div>
                                                <p class="whitespace-pre-line break-words">{{ message.content }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <textarea
                                        v-model="projectChatInput"
                                        @keydown="handleProjectChatKeydown"
                                        class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        rows="3"
                                        placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ–± –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö –ø—Ä–æ–µ–∫—Ç–∞..."
                                    ></textarea>
                                    <input
                                        v-model="projectChatExtraContext"
                                        type="text"
                                        class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)"
                                    >
                                    <div class="flex flex-wrap items-center gap-3">
                                        <button
                                            @click="sendProjectChatMessage"
                                            :disabled="projectChatLoading || !projectChatInput.trim()"
                                            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                        </button>
                                        <button
                                            @click="resetProjectChat"
                                            :disabled="projectChatLoading"
                                            class="px-5 py-3 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition-colors"
                                        >
                                            <i class="fas fa-undo mr-2"></i>
                                            –°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥
                                        </button>
                                        <div
                                            v-if="projectChatLoading"
                                            class="flex items-center text-gray-500 text-sm"
                                        >
                                            <i class="fas fa-spinner loading mr-2"></i>
                                            –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                    <h3 class="font-semibold text-gray-800 mb-2">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
                                    <ul class="space-y-2 text-sm text-gray-600 list-disc list-inside">
                                        <li>¬´–û–ø–∏—à–∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã backend-—á–∞—Å—Ç–∏¬ª</li>
                                        <li>¬´–ö–∞–∫–∏–µ —Ñ–∞–π–ª—ã –æ—Ç–≤–µ—á–∞—é—Ç –∑–∞ —Ä–∞–±–æ—Ç—É —Å Google Sheets?¬ª</li>
                                        <li>¬´–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤¬ª</li>
                                        <li>¬´–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ–∞–π–ª unified_app.py?¬ª</li>
                                    </ul>
                                </div>
                                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800">
                                    –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º–∏ README –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤ –ø–æ–ª–µ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –Ω—ë–º.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Materials Search Tab -->
                    <div v-if="activeTab === 'materials'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üîç –ü–æ–∏—Å–∫ —Ü–µ–Ω –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
                                </label>
                                <input
                                    v-model="materialSearch.name"
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500"
                                    placeholder="Cement Portland, Ceramic tiles..."
                                >
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    –û–ø—Ü–∏–∏ –ø–æ–∏—Å–∫–∞
                                </label>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input v-model="materialSearch.useCache" type="checkbox" class="mr-2">
                                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à
                                    </label>
                                    <label class="flex items-center">
                                        <input v-model="materialSearch.useScraping" type="checkbox" class="mr-2">
                                        –ü–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–æ–≤
                                    </label>
                                    <label class="flex items-center">
                                        <input v-model="materialSearch.useAdvanced" type="checkbox" class="mr-2">
                                        –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button
                            @click="searchMaterial"
                            :disabled="loading || !materialSearch.name.trim()"
                            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-search mr-2"></i>
                            –ù–∞–π—Ç–∏ —Ü–µ–Ω—É
                        </button>

                        <div v-if="materialResult" class="result-box">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <h3 class="font-bold text-lg mb-2">{{ materialResult.name }}</h3>
                                    <p class="text-gray-600">üáµüáπ {{ materialResult.pt_name }}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">{{ materialResult.price }}</div>
                                    <div class="text-gray-600">{{ materialResult.best_supplier }}</div>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-blue-50 rounded">
                                <p class="text-sm text-gray-700">{{ materialResult.reasoning }}</p>
                            </div>
                            
                            <a :href="materialResult.url" target="_blank" class="inline-block mt-3 text-blue-600 hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>
                                –û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                            </a>

                            <div v-if="materialResult.quotes && materialResult.quotes.length > 0" class="mt-4">
                                <h4 class="font-bold mb-2">–í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ({{ materialResult.quotes.length }}):</h4>
                                <div class="space-y-2">
                                    <div v-for="quote in materialResult.quotes" :key="quote.url" class="border-l-4 border-gray-300 pl-3">
                                        <div class="font-medium">{{ quote.supplier }}</div>
                                        <div class="text-sm text-gray-600">{{ quote.price }} ‚Ä¢ {{ quote.notes }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Search Tab -->
                    <div v-if="activeTab === 'batch'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üìã –ü–∞–∫–µ—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                        </h2>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –°–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)
                            </label>
                            <textarea
                                v-model="batchMaterials"
                                class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500"
                                rows="8"
                                placeholder="Cement Portland&#10;Ceramic tiles&#10;Sand 0-4mm&#10;Gravel&#10;Wood plywood 18mm"
                            ></textarea>
                        </div>

                        <button
                            @click="searchBatch"
                            :disabled="loading || !batchMaterials.trim()"
                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-list mr-2"></i>
                            –ù–∞–π—Ç–∏ –≤—Å–µ —Ü–µ–Ω—ã
                        </button>

                        <div v-if="batchResults" class="result-box">
                            <h3 class="font-bold text-lg mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¶–µ–Ω–∞</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Å—ã–ª–∫–∞</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="material in batchResults" :key="material.name">
                                            <td class="px-4 py-3 text-sm">{{ material.name }}</td>
                                            <td class="px-4 py-3 text-sm">{{ material.best_supplier }}</td>
                                            <td class="px-4 py-3 text-sm font-medium text-green-600">{{ material.price }}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <a :href="material.url" target="_blank" class="text-blue-600 hover:underline">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Google Sheets Tab -->
                    <div v-if="activeTab === 'sheets'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üìä –†–∞–±–æ—Ç–∞ —Å Google Sheets
                        </h2>

                        <div
                            v-if="stats && stats.sheet"
                            class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3"
                        >
                            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                                <div>
                                    <p class="font-semibold text-blue-900">
                                        {{ stats.sheet.spreadsheet_title }}
                                    </p>
                                    <p class="text-sm text-blue-800">
                                        –õ–∏—Å—Ç: {{ stats.sheet.worksheet }}
                                    </p>
                                    <p class="text-sm text-blue-800">
                                        –†–∞–∑–º–µ—Ä: {{ stats.sheet.rows }} √ó {{ stats.sheet.columns }}
                                    </p>
                                    <p
                                        v-if="stats.sheet.available_worksheets && stats.sheet.available_worksheets.length"
                                        class="text-xs text-blue-700 mt-1"
                                    >
                                        –î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–∏—Å—Ç—ã: {{ stats.sheet.available_worksheets.join(', ') }}
                                    </p>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                    <a
                                        v-if="stats.sheet.worksheet_url"
                                        :href="stats.sheet.worksheet_url"
                                        target="_blank"
                                        class="inline-flex items-center justify-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        –û—Ç–∫—Ä—ã—Ç—å –≤ Google Sheets
                                    </a>
                                    <button
                                        @click="loadSheetPreview"
                                        class="inline-flex items-center justify-center bg-white border border-blue-400 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-100 transition-colors"
                                    >
                                        <i class="fas fa-eye mr-2"></i>
                                        –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-blue-600">
                                –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–µ {{ sheetPreviewLimit }} —Å—Ç—Ä–æ–∫ (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫).
                            </p>
                        </div>
                        
                        <div class="grid lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 space-y-4">
                                <div class="bg-white border border-gray-200 rounded-lg shadow-sm h-96 flex flex-col">
                                    <div
                                        ref="sheetsChatScroll"
                                        class="flex-1 overflow-y-auto px-4 py-4 space-y-3"
                                    >
                                        <div
                                            v-if="!sheetsChatMessages.length"
                                            class="h-full flex flex-col items-center justify-center text-center text-gray-500"
                                        >
                                            <i class="fas fa-robot text-3xl mb-3 text-gray-400"></i>
                                            <p>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü—Ä–æ—á–∏—Ç–∞–π —Ç–∞–±–ª–∏—Ü—É¬ª –∏–ª–∏ ¬´–î–æ–±–∞–≤—å —Å—Ç–æ–ª–±–µ—Ü —Å –∏—Ç–æ–≥–∞–º–∏¬ª.</p>
                                        </div>
                                        <div
                                            v-for="message in sheetsChatMessages"
                                            :key="message.id"
                                            class="flex"
                                            :class="{
                                                'justify-end': message.role === 'user',
                                                'justify-start': message.role !== 'user'
                                            }"
                                        >
                                            <div
                                                class="max-w-full sm:max-w-xl rounded-lg px-4 py-3 shadow-sm border"
                                                :class="{
                                                    'bg-indigo-600 text-white border-indigo-600': message.role === 'user',
                                                    'bg-gray-50 text-gray-900 border-gray-200': message.role === 'assistant',
                                                    'bg-yellow-50 text-gray-900 border-yellow-200': message.role === 'system'
                                                }"
                                            >
                                                <div class="text-xs font-semibold opacity-80 mb-1 flex items-center justify-between gap-3">
                                                    <span>{{ labelSheetsChatRole(message.role) }}</span>
                                                    <span>{{ formatTimestamp(message.timestamp) }}</span>
                                                </div>
                                                <p class="whitespace-pre-line break-words">{{ message.content }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-3">
                                    <textarea
                                        v-model="sheetsChatInput"
                                        @keydown="handleSheetsChatKeydown"
                                        class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        rows="3"
                                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–û–±–Ω–æ–≤–∏ —Å—Ç–æ–ª–±–µ—Ü B: —Å—Ç–∞—Ç—É—Å ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–æ¬ª, ¬´–°–¥–µ–ª–∞–π —Å–≤–æ–¥–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º¬ª"
                                    ></textarea>
                                    <div class="flex flex-wrap items-center gap-3">
                                        <button
                                            @click="sendSheetsChatMessage"
                                            :disabled="sheetsChatLoading || !sheetsChatInput.trim()"
                                            class="flex-1 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                        </button>
                                        <button
                                            @click="resetSheetsChat"
                                            :disabled="sheetsChatLoading"
                                            class="px-5 py-3 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition-colors"
                                        >
                                            <i class="fas fa-undo mr-2"></i>
                                            –°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥
                                        </button>
                                        <div
                                            v-if="sheetsChatLoading"
                                            class="flex items-center text-gray-500 text-sm"
                                        >
                                            <i class="fas fa-spinner loading mr-2"></i>
                                            –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                    <h3 class="font-semibold text-gray-800 mb-2">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
                                    <ul class="space-y-2 text-sm text-gray-600 list-disc list-inside">
                                        <li v-for="prompt in sheetsChatSuggestions" :key="prompt">{{ prompt }}</li>
                                    </ul>
                                </div>
                                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 text-sm text-indigo-800">
                                    –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´–°–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.
                                </div>
                            </div>
                        </div>

                        <div
                            v-if="sheetsAlert"
                            class="result-box bg-yellow-50 border border-yellow-200 text-yellow-900"
                        >
                            {{ sheetsAlert }}
                        </div>

                        <div v-if="sheetPreview" class="result-box">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2">
                                <h3 class="font-bold text-lg">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ª–∏—Å—Ç–∞</h3>
                                <div class="text-sm text-gray-500">
                                    –ü–æ–∫–∞–∑–∞–Ω—ã {{ sheetPreview.visibleRows }} –∏–∑ {{ sheetPreview.totalDataRows }} —Å—Ç—Ä–æ–∫
                                    ({{ sheetPreview.totalRows }} √ó {{ sheetPreview.totalColumns }} —Å —É—á—ë—Ç–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full border border-gray-200 text-sm">
                                    <thead v-if="sheetPreview.headers.length" class="bg-gray-100">
                                        <tr>
                                            <th
                                                v-for="(header, index) in sheetPreview.headers"
                                                :key="'header-' + index"
                                                class="px-3 py-2 text-left font-medium text-gray-700 border-b border-gray-200"
                                            >
                                                {{ header || ' ' }}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr
                                            v-for="(row, rowIndex) in sheetPreview.rows"
                                            :key="'row-' + rowIndex"
                                            class="bg-white border-b border-gray-200"
                                        >
                                            <td
                                                v-for="(cell, cellIndex) in row"
                                                :key="'cell-' + rowIndex + '-' + cellIndex"
                                                class="px-3 py-2 text-gray-700"
                                            >
                                                {{ cell }}
                                            </td>
                                        </tr>
                                        <tr v-if="!sheetPreview.rows.length">
                                            <td
                                                :colspan="sheetPreview.columnCount || 1"
                                                class="px-3 py-6 text-center text-gray-500"
                                            >
                                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p
                                v-if="sheetPreview.hasMore"
                                class="mt-2 text-xs text-gray-500"
                            >
                                –ï—Å—Ç—å –µ—â—ë {{ sheetPreview.totalDataRows - sheetPreview.visibleRows }} —Å—Ç—Ä–æ–∫. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—Å—Ç –≤ Google Sheets –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.
                            </p>
                        </div>
                    </div>

                    <!-- Estimate Create Tab -->
                    <div v-if="activeTab === 'estimateCreate'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üßæ –°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ—Ç—ã
                        </h2>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        –ù–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ—Ç—ã
                                    </label>
                                    <input
                                        v-model="estimateCreate.name"
                                        type="text"
                                        class="w-full border border-gray-300 rounded-lg p-3"
                                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ–º–æ–Ω—Ç –æ—Ñ–∏—Å–∞"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        –ö–ª–∏–µ–Ω—Ç
                                    </label>
                                    <input
                                        v-model="estimateCreate.clientName"
                                        type="text"
                                        class="w-full border border-gray-300 rounded-lg p-3"
                                        placeholder="–û–û–û –†–æ–º–∞—à–∫–∞"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        –û–ø–∏—Å–∞–Ω–∏–µ
                                    </label>
                                    <textarea
                                        v-model="estimateCreate.description"
                                        class="w-full border border-gray-300 rounded-lg p-3"
                                        rows="3"
                                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
                                    ></textarea>
                                </div>
                                <label class="inline-flex items-center space-x-2 text-sm text-gray-700">
                                    <input
                                        type="checkbox"
                                        v-model="estimateCreate.autoFindPrices"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    >
                                    <span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–∞—Ç—å —Ü–µ–Ω—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–π</span>
                                </label>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <label class="inline-flex items-center space-x-2 text-sm text-gray-700">
                                        <input
                                            type="checkbox"
                                            v-model="estimateCreate.createSheet"
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        >
                                        <span>–°–æ–∑–¥–∞—Ç—å Google Sheet</span>
                                    </label>
                                    <label class="inline-flex items-center space-x-2 text-sm text-gray-700">
                                        <input
                                            type="checkbox"
                                            v-model="estimateCreate.doubleVariant"
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        >
                                        <span>–°–¥–µ–ª–∞—Ç—å 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ (—Å—Ç–∞—Ä–∞—è/–Ω–æ–≤–∞—è –ø–ª–∏—Ç–∫–∞)</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        –ò–º—è –ª–∏—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                                    </label>
                                    <input
                                        v-model="estimateCreate.worksheetName"
                                        type="text"
                                        class="w-full border border-gray-300 rounded-lg p-3"
                                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–º–µ—Ç–µ —Ç–µ—Ä—Ä–∞—Å–∞"
                                    >
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                                </label>
                                <textarea
                                    v-model="estimateCreate.textInput"
                                    class="w-full border border-gray-300 rounded-lg p-3 h-64"
                                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –º–æ–Ω—Ç–∞–∂ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫, –ø–æ–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω, —Å—Ç—è–∂–∫–∞ –ø–æ–ª–∞..."
                                ></textarea>
                            </div>
                        </div>

                        <button
                            @click="createEstimate"
                            :disabled="loading"
                            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-file-invoice mr-2"></i>
                            –°–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É
                        </button>

                        <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-gray-800">–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–º–µ—Ç–µ</h3>
                                <button
                                    @click="estimateCreateMessages = []"
                                    class="text-sm text-gray-500 hover:text-gray-700"
                                >
                                    –û—á–∏—Å—Ç–∏—Ç—å
                                </button>
                            </div>
                            <div class="h-48 overflow-y-auto border border-gray-200 rounded p-3 bg-gray-50 space-y-2 text-sm">
                                <div v-if="!estimateCreateMessages.length" class="text-gray-500">
                                    –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –≤–≤–æ–¥–Ω—ã–µ.
                                </div>
                                <div
                                    v-for="(msg, idx) in estimateCreateMessages"
                                    :key="'assist-' + idx"
                                    :class="msg.role === 'assistant' ? 'text-gray-800' : 'text-blue-800'"
                                >
                                    <span class="font-semibold">
                                        {{ msg.role === 'assistant' ? '–ò–ò' : '–í—ã' }}:
                                    </span>
                                    <span v-html="formatResult(msg.content)"></span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <input
                                    v-model="estimateCreateAssistantInput"
                                    type="text"
                                    class="flex-1 border border-gray-300 rounded-lg p-3 text-sm"
                                    placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –≤–∞—Ä–∏–∞–Ω—Ç—ã..."
                                >
                                <button
                                    @click="askEstimateAssistant"
                                    :disabled="loading || !estimateCreateAssistantInput.trim()"
                                    class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 disabled:bg-gray-400 transition-colors"
                                >
                                    –°–ø—Ä–æ—Å–∏—Ç—å
                                </button>
                                <button
                                    @click="appendAssistantToDescription"
                                    :disabled="!lastAssistantMessage"
                                    class="bg-white border border-gray-300 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-100 disabled:bg-gray-200 transition-colors"
                                >
                                    –í —Ç–µ–∫—Å—Ç —Å–º–µ—Ç—ã
                                </button>
                            </div>
                        </div>

                        <div v-if="estimateCreateResult" class="result-box">
                            <template v-if="estimateCreateResult.error">
                                <div class="text-red-600 font-semibold">
                                    –û—à–∏–±–∫–∞: {{ estimateCreateResult.error }}
                                </div>
                            </template>
                            <template v-else-if="estimateCreateResult.estimate">
                                <div class="space-y-2">
                                    <div class="font-bold text-lg text-gray-800">
                                        –°–º–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: {{ estimateCreateResult.estimate.metadata.name }}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        ID: {{ estimateCreateResult.estimate.metadata.id }}
                                    </div>
                                    <div class="text-gray-800">
                                        –ü–æ–∑–∏—Ü–∏–∏: {{ estimateCreateResult.estimate.summary.items_count }} ¬∑ –ò—Ç–æ–≥: {{ estimateCreateResult.estimate.summary.total }}
                                    </div>
                                    <div v-if="estimateCreateResult.estimate.metadata.description" class="text-gray-700">
                                        {{ estimateCreateResult.estimate.metadata.description }}
                                    </div>
                                    <div v-if="estimateCreateResult.estimate.items && estimateCreateResult.estimate.items.length" class="pt-2">
                                        <div class="font-semibold text-gray-800 mb-1">–ü–µ—Ä–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏:</div>
                                        <ul class="list-disc pl-5 space-y-1 text-gray-800">
                                            <li
                                                v-for="item in estimateCreateResult.estimate.items.slice(0, 3)"
                                                :key="item.id"
                                            >
                                                {{ item.name }} ‚Äî {{ item.quantity }} {{ item.unit }} √ó {{ item.unit_price }} = {{ item.total_price }}
                                            </li>
                                        </ul>
                                        <div v-if="estimateCreateResult.estimate.items.length > 3" class="text-sm text-gray-500 mt-1">
                                            –ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 3 –∏–∑ {{ estimateCreateResult.estimate.items.length }} –ø–æ–∑–∏—Ü–∏–π.
                                        </div>
                                    </div>
                                    <div v-if="estimateCreateResult.sheets && estimateCreateResult.sheets.length" class="pt-2 space-y-1">
                                        <div class="font-semibold text-gray-800">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã:</div>
                                        <div
                                            v-for="(sheet, idx) in estimateCreateResult.sheets"
                                            :key="'sheet-' + idx"
                                            class="flex items-center space-x-2 text-blue-700"
                                        >
                                            <i class="fas fa-link"></i>
                                            <a :href="sheet.url" target="_blank" class="underline">{{ sheet.title }}</a>
                                            <span class="text-gray-600">‚Äî {{ sheet.rows }} —Å—Ç—Ä–æ–∫ ¬∑ {{ sheet.subtotal.toFixed(2) }} ‚Üí {{ sheet.total_with_iva.toFixed(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Format AI Tab -->
                    <div v-if="activeTab === 'formatAI'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">
                            ü™Ñ –§–æ—Ä–º–∞—Ç AI ‚Äî –ø—Ä–∏–≤–µ—Å—Ç–∏ —Å–º–µ—Ç—É –∫ –Ω–∞—à–µ–º—É —Ñ–æ—Ä–º–∞—Ç—É
                        </h2>
                        <p class="text-gray-600 mb-4">
                            –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ ID Google-—Ç–∞–±–ª–∏—Ü—ã —Å–æ —Å–º–µ—Ç–æ–π ‚Äî –∞–≥–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–æ–ª–æ–Ω–∫–∏ –∏ —Å–æ–∑–¥–∞—Å—Ç –ª–∏—Å—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ VIORA.
                        </p>

                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –°—Å—ã–ª–∫–∞ –∏–ª–∏ ID —Ç–∞–±–ª–∏—Ü—ã
                            </label>
                            <input
                                v-model="estimateFormat.source"
                                @change="loadFormatHeaders"
                                type="text"
                                class="w-full border border-gray-300 rounded-lg p-3"
                                placeholder="https://docs.google.com/spreadsheets/d/..."
                            >
                        </div>

                        <div v-if="estimateFormat.headers && estimateFormat.headers.length" class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                –ö–æ–ª–æ–Ω–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                            </label>
                            <select
                                v-model="estimateFormat.descriptionColumn"
                                class="w-full border border-gray-300 rounded-lg p-3"
                            >
                                <option value="">–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</option>
                                <option v-for="(h, idx) in estimateFormat.headers" :key="'hdr-'+idx" :value="h">
                                    {{ h || '(–ø—É—Å—Ç–∞—è —è—á–µ–π–∫–∞)' }}
                                </option>
                            </select>
                        </div>

                        <button
                            @click="formatEstimate"
                            :disabled="loading || !estimateFormat.source.trim()"
                            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>
                            –ó–∞–ø—É—Å—Ç–∏—Ç—å –§–æ—Ä–º–∞—Ç AI
                        </button>

                        <div v-if="estimateFormatResult" class="result-box">
                            <template v-if="estimateFormatResult.error">
                                <div class="text-red-600 font-semibold">
                                    –û—à–∏–±–∫–∞: {{ estimateFormatResult.error }}
                                </div>
                            </template>
                            <template v-else>
                                <div class="space-y-2">
                                    <div class="font-semibold text-gray-800">
                                        –°–º–µ—Ç–∞: {{ estimateFormatResult.estimate.metadata.name }}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        –ü–æ–∑–∏—Ü–∏–∏: {{ estimateFormatResult.estimate.summary.items_count }}
                                        ¬∑ –ò—Ç–æ–≥: {{ estimateFormatResult.estimate.summary.total }}
                                    </div>
                                    <div v-if="estimateFormatResult.sheets && estimateFormatResult.sheets.length" class="space-y-1">
                                        <div class="font-semibold text-gray-800 mt-2">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã:</div>
                                        <div
                                            v-for="(sheet, idx) in estimateFormatResult.sheets"
                                            :key="'format-sheet-' + idx"
                                            class="flex items-center space-x-2 text-blue-700"
                                        >
                                            <i class="fas fa-link"></i>
                                            <a :href="sheet.url" target="_blank" class="underline">{{ sheet.title }}</a>
                                            <span class="text-gray-600">‚Äî {{ sheet.spreadsheet_title }}</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Estimate Check Tab -->
                    <div v-if="activeTab === 'estimate'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üèóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π —Å–º–µ—Ç—ã
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    –õ–∏—Å—Ç —Å–æ —Å–º–µ—Ç–æ–π (–∏–º—è –∏–ª–∏ URL —Ç–∞–±–ª–∏—Ü—ã)
                                </label>
                                <input
                                    v-model="estimateCheck.estimateSheet"
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3"
                                    placeholder="Sheet1 –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ Google Sheet"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    –ú–∞—Å—Ç–µ—Ä-–ª–∏—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                                </label>
                                <input
                                    v-model="estimateCheck.masterSheet"
                                    type="text"
                                    class="w-full border border-gray-300 rounded-lg p-3"
                                    placeholder="Master List (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                                >
                            </div>
                        </div>

                        <button
                            @click="checkEstimate"
                            :disabled="loading"
                            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-check-circle mr-2"></i>
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–º–µ—Ç—É
                        </button>

                        <button
                            @click="setupEstimateConstructor"
                            :disabled="loading"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors"
                        >
                            <i class="fas fa-hammer mr-2"></i>
                            –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–º–µ—Ç—ã –≤ Sheets
                        </button>

                        <div v-if="estimateSetupMessage" class="result-box">
                            <div class="whitespace-pre-wrap" v-html="formatResult(estimateSetupMessage)"></div>
                        </div>

                        <div v-if="estimateResult" class="result-box">
                            <div class="whitespace-pre-wrap" v-html="formatResult(estimateResult)"></div>
                        </div>
                    </div>

                    <!-- Stats Tab -->
                    <div v-if="activeTab === 'stats'" class="space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </h2>
                        
                        <button
                            @click="loadStats"
                            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors"
                        >
                            <i class="fas fa-sync-alt mr-2"></i>
                            –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        </button>

                        <div v-if="stats" class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4">–ö—ç—à</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</span>
                                        <span class="font-bold">{{ stats.cache.total_materials }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–ê–∫—Ç—É–∞–ª—å–Ω—ã—Ö:</span>
                                        <span class="font-bold text-green-600">{{ stats.cache.fresh_materials }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–£—Å—Ç–∞—Ä–µ–≤—à–∏—Ö:</span>
                                        <span class="font-bold text-red-600">{{ stats.cache.expired_materials }}</span>
                                    </div>
                                </div>
                                <button
                                    @click="clearCache"
                                    class="mt-4 w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors"
                                >
                                    <i class="fas fa-trash mr-2"></i>
                                    –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
                                </button>
                            </div>

                            <div class="bg-white border border-gray-200 rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>–ú–æ–¥–µ–ª—å:</span>
                                        <span class="font-mono">{{ stats.config.model }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–ö—ç—à:</span>
                                        <span :class="stats.config.cache_enabled ? 'text-green-600' : 'text-red-600'">
                                            {{ stats.config.cache_enabled ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Google Sheets:</span>
                                        <span :class="stats.config.sheets_enabled ? 'text-green-600' : 'text-red-600'">
                                            {{ stats.config.sheets_enabled ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫:</span>
                                        <span :class="stats.config.advanced_search_enabled ? 'text-green-600' : 'text-red-600'">
                                            {{ stats.config.advanced_search_enabled ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–õ–æ–∫–∞–ª—å–Ω–∞—è LLM:</span>
                                        <span :class="stats.config.local_llm_enabled ? 'text-green-600' : 'text-gray-500'">
                                            {{ stats.config.local_llm_enabled ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–í—ã–∫–ª—é—á–µ–Ω–∞' }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div
                                v-if="stats.materials_db"
                                class="bg-white border border-gray-200 rounded-lg p-6 md:col-span-2"
                            >
                                <h3 class="font-bold text-lg mb-4">–ë–∞–∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>–ü–æ–º–æ—â–Ω–∏–∫:</span>
                                        <span :class="stats.materials_db.assistant_enabled ? 'text-green-600' : 'text-red-600'">
                                            {{ stats.materials_db.assistant_enabled ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Google Sheet:</span>
                                        <span :class="stats.materials_db.sheet_enabled ? 'text-green-600' : 'text-gray-500'">
                                            {{ stats.materials_db.sheet_enabled ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–ù–µ –∑–∞–¥–∞–Ω' }}
                                        </span>
                                    </div>
                                    <div
                                        v-if="stats.materials_db.worksheets && stats.materials_db.worksheets.length"
                                        class="text-xs text-gray-500"
                                    >
                                        –õ–∏—Å—Ç—ã: {{ stats.materials_db.worksheets.join(', ') }}
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è CSV:</span>
                                        <span :class="stats.materials_db.sync_csv ? 'text-green-600' : 'text-gray-500'">
                                            {{ stats.materials_db.sync_csv ? '–í–∫–ª—é—á–µ–Ω–∞' : '–í—ã–∫–ª—é—á–µ–Ω–∞' }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>–û–∂–∏–¥–∞—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:</span>
                                        <span class="font-bold">
                                            {{ stats.materials_db.pending_changes }}
                                        </span>
                                    </div>
                                    <div
                                        v-if="stats.materials_db.sheet_id"
                                        class="text-xs text-gray-500 break-words"
                                    >
                                        Sheet ID: {{ stats.materials_db.sheet_id }}
                                    </div>
                                    <div
                                        v-if="stats.materials_db.worksheet"
                                        class="text-xs text-gray-500 break-words"
                                    >
                                        –õ–∏—Å—Ç: {{ stats.materials_db.worksheet }}
                                    </div>
                                    <div
                                        v-if="stats.materials_db.csv_path"
                                        class="text-xs text-gray-500 break-words"
                                    >
                                        CSV: {{ stats.materials_db.csv_path }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div v-if="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-8 text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                    <p class="text-lg font-medium">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...</p>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2024 Construction AI Agent. –í—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.</p>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'projectChat',
                    loading: false,
                    tabs: [
                        { id: 'projectChat', name: '–ê—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞', icon: 'fas fa-comments' },
                        { id: 'universal', name: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π', icon: 'fas fa-magic' },
                        { id: 'materials', name: '–ü–æ–∏—Å–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤', icon: 'fas fa-search' },
                        { id: 'batch', name: '–ü–∞–∫–µ—Ç–Ω—ã–π –ø–æ–∏—Å–∫', icon: 'fas fa-list' },
                        { id: 'sheets', name: 'Google Sheets', icon: 'fas fa-table' },
                        { id: 'estimateCreate', name: '–°–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ—Ç', icon: 'fas fa-file-invoice' },
                        { id: 'formatAI', name: '–§–æ—Ä–º–∞—Ç AI', icon: 'fas fa-wand-magic-sparkles' },
                        { id: 'estimate', name: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ç', icon: 'fas fa-check-circle' },
                        { id: 'stats', name: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', icon: 'fas fa-chart-bar' },
                    ],
                    universalCommand: '',
                    universalResult: null,
                    universalHistory: [],
                    historyActiveId: null,
                    historyLimit: 20,
                    historyStorageKey: 'construction-ai-agent-history',
                    projectChatMessages: [],
                    projectChatInput: '',
                    projectChatExtraContext: '',
                    projectChatLoading: false,
                    projectChatHistoryKey: 'construction-ai-project-chat',
                    materialSearch: {
                        name: '',
                        useCache: true,
                        useScraping: false,
                        useAdvanced: false,
                    },
                    materialResult: null,
                    batchMaterials: '',
                    batchResults: null,
                    sheetsChatMessages: [],
                    sheetsChatInput: '',
                    sheetsChatLoading: false,
                    sheetsChatHistoryKey: 'construction-ai-sheets-chat',
                    sheetsChatInitialized: false,
                    sheetsChatSuggestions: [
                        '–ü—Ä–æ—á–∏—Ç–∞–π —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏ –ø–æ –∑–∞—Ç—Ä–∞—Ç–∞–º',
                        '–°–≥—Ä—É–ø–ø–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –ø–æ–∫–∞–∂–∏ —Å—É–º–º—ã',
                        '–î–æ–±–∞–≤—å —Å—Ç–æ–ª–±–µ—Ü ¬´–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è¬ª –∏ –æ—Ç–º–µ—Ç—å —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ "–í —Ä–∞–±–æ—Ç–µ"',
                        '–ù–∞–π–¥–∏ —Å—Ç—Ä–æ–∫–∏, –≥–¥–µ —Ü–µ–Ω–∞ –≤—ã—à–µ 1000, –∏ –ø–æ–∫–∞–∂–∏ –∏—Ö',
                    ],
                    sheetsAlert: null,
                    sheetPreview: null,
                    sheetPreviewLimit: 20,
                    estimateCreate: {
                        name: '',
                        description: '',
                        clientName: '',
                        textInput: '',
                        autoFindPrices: true,
                        createSheet: true,
                        worksheetName: '',
                        doubleVariant: true,
                    },
                    estimateCreateMessages: [],
                    estimateCreateAssistantInput: '',
                    estimateCreateResult: null,
                    estimateFormat: {
                        source: '',
                        descriptionColumn: '',
                        headers: [],
                    },
                    estimateFormatResult: null,
                    estimateCheck: {
                        estimateSheet: '',
                        masterSheet: '',
                    },
                    estimateResult: null,
                    estimateSetupMessage: null,
                    stats: null,
                };
            },
            computed: {
                    sheetEmbedUrl() {
                        if (!this.stats || !this.stats.sheet) {
                            return null;
                        }
                    const sheet = this.stats.sheet;
                    const spreadsheetId = sheet.spreadsheet_id;
                    if (!spreadsheetId) {
                        return null;
                    }
                    const rawId = sheet.worksheet_id ?? sheet.worksheetId;
                    let gidValue = 0;
                        if (rawId !== undefined && rawId !== null) {
                            const numeric = Number(rawId);
                            gidValue = Number.isFinite(numeric) ? numeric : rawId;
                        }
                        const gid = encodeURIComponent(gidValue);
                        return `https://docs.google.com/spreadsheets/d/${spreadsheetId}/htmlembed?gid=${gid}`;
                    },
                    lastAssistantMessage() {
                        const reversed = [...this.estimateCreateMessages].reverse();
                        const found = reversed.find(m => m.role === 'assistant');
                        return found ? found.content : '';
                    },
                },
                async loadFormatHeaders() {
                    if (!this.estimateFormat.source.trim()) {
                        this.estimateFormat.headers = [];
                        this.estimateFormat.descriptionColumn = '';
                        return;
                    }
                    try {
                        const payload = {
                            google_sheet_id: this.extractSheetId(this.estimateFormat.source),
                        };
                        const response = await fetch('/api/estimate/headers', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.estimateFormat.headers = data.headers || [];
                        } else {
                            this.estimateFormat.headers = [];
                        }
                    } catch (error) {
                        this.estimateFormat.headers = [];
                    }
                },
            watch: {
                activeTab(newTab) {
                    if (newTab === 'sheets') {
                        this.ensureSheetsChatInitialized();
                        this.loadStats();
                    }
                },
            },
            methods: {
                async processUniversalCommand() {
                    this.loading = true;
                    this.universalResult = null;
                    const commandText = this.universalCommand.trim();
                    try {
                        const response = await fetch('/api/command', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ command: this.universalCommand }),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.universalResult = data.result;
                            this.addHistoryEntry(commandText, data.result, true);
                        } else {
                            const message = `–û—à–∏–±–∫–∞: ${data.error}`;
                            this.universalResult = message;
                            this.addHistoryEntry(commandText, message, false);
                        }
                    } catch (error) {
                        const message = `–û—à–∏–±–∫–∞: ${error.message}`;
                        this.universalResult = message;
                        this.addHistoryEntry(commandText, message, false);
                    } finally {
                        this.loading = false;
                    }
                },
                labelProjectChatRole(role) {
                    if (role === 'user') return '–í—ã';
                    if (role === 'assistant') return '–ê–≥–µ–Ω—Ç';
                    if (role === 'system') return '–°–∏—Å—Ç–µ–º–∞';
                    return '–°–æ–æ–±—â–µ–Ω–∏–µ';
                },
                labelSheetsChatRole(role) {
                    if (role === 'user') return '–í—ã';
                    if (role === 'assistant') return 'Sheets AI';
                    if (role === 'system') return '–°–∏—Å—Ç–µ–º–∞';
                    return '–°–æ–æ–±—â–µ–Ω–∏–µ';
                },
                handleProjectChatKeydown(event) {
                    if (event.key !== 'Enter' || event.shiftKey) {
                        return;
                    }
                    const text = this.projectChatInput.trim();
                    if (!text || this.projectChatLoading) {
                        event.preventDefault();
                        return;
                    }
                    event.preventDefault();
                    this.sendProjectChatMessage();
                },
                handleSheetsChatKeydown(event) {
                    if (event.key !== 'Enter' || event.shiftKey) {
                        return;
                    }
                    const text = this.sheetsChatInput.trim();
                    if (!text || this.sheetsChatLoading) {
                        event.preventDefault();
                        return;
                    }
                    event.preventDefault();
                    this.sendSheetsChatMessage();
                },
                async sendProjectChatMessage() {
                    const text = this.projectChatInput.trim();
                    if (!text || this.projectChatLoading) {
                        return;
                    }
                    const userMessage = {
                        id: `${Date.now()}-user`,
                        role: 'user',
                        content: text,
                        timestamp: new Date().toISOString(),
                    };
                    this.projectChatMessages.push(userMessage);
                    this.projectChatInput = '';
                    this.projectChatLoading = true;
                    try {
                        const payload = { message: text };
                        const extra = this.projectChatExtraContext.trim();
                        if (extra) {
                            payload.extra_context = extra;
                        }
                        const response = await fetch('/api/project-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.projectChatMessages.push({
                                id: `${Date.now()}-assistant`,
                                role: 'assistant',
                                content: data.reply,
                                timestamp: data.timestamp || new Date().toISOString(),
                            });
                        } else {
                            this.projectChatMessages.push({
                                id: `${Date.now()}-error`,
                                role: 'system',
                                content: `–û—à–∏–±–∫–∞: ${data.error}`,
                                timestamp: new Date().toISOString(),
                            });
                        }
                    } catch (error) {
                        this.projectChatMessages.push({
                            id: `${Date.now()}-exception`,
                            role: 'system',
                            content: `–û—à–∏–±–∫–∞: ${error.message}`,
                            timestamp: new Date().toISOString(),
                        });
                    } finally {
                        this.projectChatLoading = false;
                        this.saveProjectChatHistory();
                        this.$nextTick(() => this.scrollProjectChatToBottom());
                    }
                },
                async resetProjectChat() {
                    if (this.projectChatLoading) {
                        return;
                    }
                    this.projectChatLoading = true;
                    this.projectChatMessages = [];
                    try {
                        const response = await fetch('/api/project-chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reset: true }),
                        });
                        const data = await response.json();
                        if (data.success && data.reply) {
                            this.projectChatMessages.push({
                                id: `${Date.now()}-reset`,
                                role: 'system',
                                content: data.reply,
                                timestamp: data.timestamp || new Date().toISOString(),
                            });
                        } else if (!data.success) {
                            this.projectChatMessages.push({
                                id: `${Date.now()}-reset-error`,
                                role: 'system',
                                content: `–û—à–∏–±–∫–∞: ${data.error}`,
                                timestamp: new Date().toISOString(),
                            });
                        }
                    } catch (error) {
                        this.projectChatMessages.push({
                            id: `${Date.now()}-reset-exception`,
                            role: 'system',
                            content: `–û—à–∏–±–∫–∞: ${error.message}`,
                            timestamp: new Date().toISOString(),
                        });
                    } finally {
                        this.projectChatLoading = false;
                        this.projectChatInput = '';
                        this.saveProjectChatHistory();
                        this.$nextTick(() => this.scrollProjectChatToBottom());
                    }
                },
                saveProjectChatHistory() {
                    try {
                        localStorage.setItem(
                            this.projectChatHistoryKey,
                            JSON.stringify(this.projectChatMessages),
                        );
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ —á–∞—Ç–∞', error);
                    }
                },
                loadProjectChatHistory() {
                    try {
                        const raw = localStorage.getItem(this.projectChatHistoryKey);
                        if (!raw) {
                            return;
                        }
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) {
                            this.projectChatMessages = parsed;
                        }
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ —á–∞—Ç–∞', error);
                    }
                },
                scrollProjectChatToBottom() {
                    const container = this.$refs.projectChatScroll;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                enrichSheetsHistory(history) {
                    const base = Date.now();
                    return (history || []).map((entry, index) => ({
                        id: `sheets-${base + index}`,
                        role: entry.role || 'assistant',
                        content: entry.content || '',
                        timestamp: entry.timestamp || new Date(base + index).toISOString(),
                    }));
                },
                async loadSheetsChatHistory() {
                    try {
                        const response = await fetch('/api/sheets/command');
                        const data = await response.json();
                        if (data.success && Array.isArray(data.history)) {
                            this.sheetsChatMessages = this.enrichSheetsHistory(data.history);
                            this.sheetsChatInitialized = true;
                            this.saveSheetsChatHistory();
                            this.$nextTick(() => this.scrollSheetsChatToBottom());
                            return;
                        } else if (!data.success) {
                            this.sheetsAlert = `–û—à–∏–±–∫–∞: ${data.error}`;
                        }
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é Google Sheets –∏–∑ API', error);
                        this.sheetsAlert = `–û—à–∏–±–∫–∞: ${error.message}`;
                    }
                    this.loadSheetsChatHistoryFromStorage();
                },
                loadSheetsChatHistoryFromStorage() {
                    try {
                        const raw = localStorage.getItem(this.sheetsChatHistoryKey);
                        if (!raw) {
                            return;
                        }
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) {
                            this.sheetsChatMessages = parsed;
                            this.sheetsChatInitialized = true;
                        }
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é Google Sheets', error);
                    }
                },
                saveSheetsChatHistory() {
                    try {
                        localStorage.setItem(
                            this.sheetsChatHistoryKey,
                            JSON.stringify(this.sheetsChatMessages),
                        );
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é Google Sheets', error);
                    }
                },
                ensureSheetsChatInitialized() {
                    if (!this.sheetsChatInitialized) {
                        this.loadSheetsChatHistory();
                    } else {
                        this.$nextTick(() => this.scrollSheetsChatToBottom());
                    }
                },
                async sendSheetsChatMessage() {
                    const text = this.sheetsChatInput.trim();
                    if (!text || this.sheetsChatLoading) {
                        return;
                    }
                    this.sheetsAlert = null;
                    const userMessage = {
                        id: `${Date.now()}-sheets-user`,
                        role: 'user',
                        content: text,
                        timestamp: new Date().toISOString(),
                    };
                    this.sheetsChatMessages.push(userMessage);
                    this.sheetsChatInput = '';
                    this.sheetsChatLoading = true;
                    this.saveSheetsChatHistory();
                    this.$nextTick(() => this.scrollSheetsChatToBottom());

                    try {
                        const response = await fetch('/api/sheets/command', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ command: text }),
                        });
                        const data = await response.json();
                        if (data.success && Array.isArray(data.history)) {
                            this.sheetsChatMessages = this.enrichSheetsHistory(data.history);
                            this.sheetsChatInitialized = true;
                            this.saveSheetsChatHistory();
                        } else {
                            const message = data.error ? `–û—à–∏–±–∫–∞: ${data.error}` : '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Sheets AI';
                            this.sheetsChatMessages.push({
                                id: `${Date.now()}-sheets-error`,
                                role: 'system',
                                content: message,
                                timestamp: new Date().toISOString(),
                            });
                            this.saveSheetsChatHistory();
                        }
                    } catch (error) {
                        this.sheetsChatMessages.push({
                            id: `${Date.now()}-sheets-exception`,
                            role: 'system',
                            content: `–û—à–∏–±–∫–∞: ${error.message}`,
                            timestamp: new Date().toISOString(),
                        });
                        this.saveSheetsChatHistory();
                    } finally {
                        this.sheetsChatLoading = false;
                        this.$nextTick(() => this.scrollSheetsChatToBottom());
                    }
                },
                async resetSheetsChat() {
                    if (this.sheetsChatLoading) {
                        return;
                    }
                    this.sheetsChatLoading = true;
                    this.sheetsAlert = null;
                    try {
                        const response = await fetch('/api/sheets/command', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reset: true }),
                        });
                        const data = await response.json();
                        if (data.success && Array.isArray(data.history)) {
                            this.sheetsChatMessages = this.enrichSheetsHistory(data.history);
                            this.sheetsChatInitialized = true;
                            this.saveSheetsChatHistory();
                        } else {
                            const message = data.error ? `–û—à–∏–±–∫–∞: ${data.error}` : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å –¥–∏–∞–ª–æ–≥ Google Sheets';
                            this.sheetsChatMessages.push({
                                id: `${Date.now()}-sheets-reset-error`,
                                role: 'system',
                                content: message,
                                timestamp: new Date().toISOString(),
                            });
                            this.saveSheetsChatHistory();
                        }
                    } catch (error) {
                        this.sheetsChatMessages.push({
                            id: `${Date.now()}-sheets-reset-exception`,
                            role: 'system',
                            content: `–û—à–∏–±–∫–∞: ${error.message}`,
                            timestamp: new Date().toISOString(),
                        });
                        this.saveSheetsChatHistory();
                    } finally {
                        this.sheetsChatLoading = false;
                        this.$nextTick(() => this.scrollSheetsChatToBottom());
                    }
                },
                scrollSheetsChatToBottom() {
                    const container = this.$refs.sheetsChatScroll;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                addHistoryEntry(command, result, success) {
                    if (!command) {
                        return;
                    }
                    const entry = {
                        id: Date.now(),
                        command,
                        result,
                        success,
                        timestamp: new Date().toISOString(),
                    };
                    this.universalHistory.unshift(entry);
                    if (this.universalHistory.length > this.historyLimit) {
                        this.universalHistory.splice(this.historyLimit);
                    }
                    this.historyActiveId = entry.id;
                    this.saveHistory();
                },
                async searchMaterial() {
                    this.loading = true;
                    this.materialResult = null;
                    try {
                        const response = await fetch('/api/materials/search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                material_name: this.materialSearch.name,
                                use_cache: this.materialSearch.useCache,
                                use_scraping: this.materialSearch.useScraping,
                                use_advanced_search: this.materialSearch.useAdvanced,
                            }),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.materialResult = data.material;
                        } else {
                            alert(`–û—à–∏–±–∫–∞: ${data.error}`);
                        }
                    } catch (error) {
                        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                loadHistoryEntry(item) {
                    this.universalCommand = item.command;
                    this.universalResult = item.result;
                    this.historyActiveId = item.id;
                },
                clearHistory() {
                    this.universalHistory = [];
                    this.historyActiveId = null;
                    try {
                        localStorage.removeItem(this.historyStorageKey);
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', error);
                    }
                },
                saveHistory() {
                    try {
                        localStorage.setItem(
                            this.historyStorageKey,
                            JSON.stringify(this.universalHistory),
                        );
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤', error);
                    }
                },
                loadHistoryFromStorage() {
                    try {
                        const raw = localStorage.getItem(this.historyStorageKey);
                        if (!raw) {
                            return;
                        }
                        const parsed = JSON.parse(raw);
                        if (Array.isArray(parsed)) {
                            this.universalHistory = parsed;
                        }
                    } catch (error) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤', error);
                    }
                },
                async searchBatch() {
                    this.loading = true;
                    this.batchResults = null;
                    try {
                        const materials = this.batchMaterials.split('\n').filter(m => m.trim());
                        const response = await fetch('/api/materials/batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ materials }),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.batchResults = data.materials;
                        } else {
                            alert(`–û—à–∏–±–∫–∞: ${data.error}`);
                        }
                    } catch (error) {
                        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                async loadSheetPreview() {
                    this.loading = true;
                    this.sheetsAlert = null;
                    try {
                        const response = await fetch('/api/sheets/read');
                        const data = await response.json();
                        if (data.success) {
                            const rawData = data.data || [];
                            const previewLimit = this.sheetPreviewLimit;
                            const trimmed = rawData.slice(0, previewLimit);

                            let headers = [];
                            let rows = [];

                            if (trimmed.length > 0) {
                                headers = trimmed[0];
                                rows = trimmed.slice(1);
                            } else if (rawData.length > 0) {
                                headers = rawData[0];
                                rows = rawData.slice(1, previewLimit);
                            }

                            const columnCount = headers.length || (rows[0] ? rows[0].length : 0);
                            const visibleRows = rows.length;
                            const totalDataRows = Math.max(data.rows - 1, 0);

                        this.sheetPreview = {
                            headers,
                            rows,
                            columnCount,
                            visibleRows,
                            totalDataRows,
                            totalRows: data.rows,
                            totalColumns: data.columns,
                            hasMore: totalDataRows > visibleRows,
                        };
                    } else {
                        this.sheetsAlert = `–û—à–∏–±–∫–∞: ${data.error}`;
                        this.sheetPreview = null;
                    }
                } catch (error) {
                    this.sheetsAlert = `–û—à–∏–±–∫–∞: ${error.message}`;
                    this.sheetPreview = null;
                } finally {
                    this.loading = false;
                }
            },
                async createEstimate() {
                    if (!this.estimateCreate.textInput.trim()) {
                        this.estimateCreateResult = { error: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç' };
                        return;
                    }
                    const now = new Date();
                    const autoName = this.estimateCreate.name.trim() || `–°–º–µ—Ç–∞ ${now.toLocaleDateString('ru-RU')}`;
                    const shortText = this.estimateCreate.textInput.trim().slice(0, 80);
                    const autoDescription = this.estimateCreate.description.trim() || `–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. ${shortText}`;
                    const autoClient = this.estimateCreate.clientName.trim() || '–ö–ª–∏–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–Ω';
                    this.loading = true;
                    this.estimateCreateResult = null;
                    try {
                        const payload = {
                            name: autoName,
                            description: autoDescription,
                            client_name: autoClient,
                            text_input: this.estimateCreate.textInput,
                            auto_find_prices: this.estimateCreate.autoFindPrices,
                            create_sheet: this.estimateCreate.createSheet,
                            worksheet_name: this.estimateCreate.worksheetName,
                            double_variant: this.estimateCreate.doubleVariant,
                        };
                        const response = await fetch('/api/estimate/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const data = await response.json();
                        if (data.success) {
                            const estimatePayload = data.estimate?.estimate || data.estimate || null;
                            const sheets = data.estimate?.sheets || data.sheets || [];
                            this.estimateCreateResult = { success: true, estimate: estimatePayload, sheets };
                        } else {
                            this.estimateCreateResult = { error: data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–º–µ—Ç—É' };
                        }
                    } catch (error) {
                        this.estimateCreateResult = { error: error.message };
                    } finally {
                        this.loading = false;
                    }
                },
                async askEstimateAssistant() {
                    const question = this.estimateCreateAssistantInput.trim();
                    if (!question) return;
                    this.estimateCreateMessages.push({ role: 'user', content: question });
                    this.loading = true;
                    try {
                        const response = await fetch('/api/estimate/assistant', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ messages: this.estimateCreateMessages }),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.estimateCreateMessages.push({ role: 'assistant', content: data.reply });
                        } else {
                            this.estimateCreateMessages.push({ role: 'assistant', content: `–û—à–∏–±–∫–∞: ${data.error}` });
                        }
                    } catch (error) {
                        this.estimateCreateMessages.push({ role: 'assistant', content: `–û—à–∏–±–∫–∞: ${error.message}` });
                    } finally {
                        this.loading = false;
                        this.estimateCreateAssistantInput = '';
                    }
                },
                appendAssistantToDescription() {
                    if (!this.lastAssistantMessage) return;
                    const joiner = this.estimateCreate.textInput ? '\n' : '';
                    this.estimateCreate.textInput = `${this.estimateCreate.textInput}${joiner}${this.lastAssistantMessage}`;
                },
                async setupEstimateConstructor() {
                    this.loading = true;
                    this.estimateSetupMessage = null;
                    try {
                        const response = await fetch('/api/estimate/setup-constructor', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({}),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.estimateSetupMessage = data.message || '–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–º–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω.';
                        } else {
                            this.estimateSetupMessage = `–û—à–∏–±–∫–∞: ${data.error}`;
                        }
                    } catch (error) {
                        this.estimateSetupMessage = `–û—à–∏–±–∫–∞: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                async checkEstimate() {
                    this.loading = true;
                    this.estimateResult = null;
                    try {
                        const response = await fetch('/api/estimate/check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.estimateCheck),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.estimateResult = data.report;
                        } else {
                            this.estimateResult = `–û—à–∏–±–∫–∞: ${data.error}`;
                        }
                    } catch (error) {
                        this.estimateResult = `–û—à–∏–±–∫–∞: ${error.message}`;
                    } finally {
                        this.loading = false;
                    }
                },
                extractSheetId(raw) {
                    if (!raw) return '';
                    const urlPattern = /https:\/\/docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/;
                    const match = raw.match(urlPattern);
                    if (match && match[1]) return match[1];
                    return raw.trim();
                },
                async formatEstimate() {
                    this.loading = true;
                    this.estimateFormatResult = null;
                    try {
                        const payload = {
                            google_sheet_id: this.extractSheetId(this.estimateFormat.source),
                            column_map: this.estimateFormat.descriptionColumn
                                ? { description: this.estimateFormat.descriptionColumn }
                                : undefined,
                        };

                        const response = await fetch('/api/estimate/import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.estimateFormatResult = data.estimate;
                        } else {
                            this.estimateFormatResult = { error: data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ—Ç—É' };
                        }
                    } catch (error) {
                        this.estimateFormatResult = { error: error.message };
                    } finally {
                        this.loading = false;
                    }
                },
                async loadStats() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/stats');
                        const data = await response.json();
                        this.stats = data;
                        this.sheetPreview = null;
                    } catch (error) {
                        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                async clearCache() {
                    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à?')) return;
                    this.loading = true;
                    try {
                        const response = await fetch('/api/cache/clear', { method: 'POST' });
                        const data = await response.json();
                        if (data.success) {
                            alert('–ö—ç—à –æ—á–∏—â–µ–Ω');
                            this.loadStats();
                        }
                    } catch (error) {
                        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                formatTimestamp(timestamp) {
                    try {
                        const date = new Date(timestamp);
                        return date.toLocaleTimeString('ru-RU', {
                            hour: '2-digit',
                            minute: '2-digit',
                        });
                    } catch (error) {
                        return '';
                    }
                },
                formatResult(text) {
                    if (!text) return '';
                    // Convert markdown-style formatting to HTML
                    return text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                },
            },
            mounted() {
                this.loadHistoryFromStorage();
                this.loadProjectChatHistory();
                this.$nextTick(() => this.scrollProjectChatToBottom());
                this.loadStats();
            },
        }).mount('#app');
    </script>
</body>
</html>
