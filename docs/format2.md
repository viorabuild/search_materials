# Формат 2 (переписывание листа + перевод)

Формат 2 работает поверх Google Sheets и обычно переписывает исходный лист, добавляя переводы и формулы.

## Что делает
- Читает выбранный лист Google Sheets, распознаёт колонки (описание, ед., количество, цена, номер, код).
- Строит позиции с `translation_id` (учитывает пропуски пустых описаний, разделы без единиц/цены определяются как секции).
- При `translate=true` (по умолчанию) отправляет описания в LLM для перевода `translate_from -> translate_to` (стандартно pt → ru).
- Собирает таблицу с заголовком `ID на мастер лист, №, Описание, Единица измерения, Количество, Цена за штуку (€), Сумма (€), Перевод` и формулами сумм.
- Записывает результат в целевую таблицу: либо в тот же лист (`rewrite_source_sheet=true`), либо в лист с суффиксом “— Формат 2”, либо в новую таблицу при `create_new_spreadsheet=true`.

## HTTP API пример
`POST /api/estimate/import`
```json
{
  "google_sheet_id": "SHEET_ID",
  "worksheet_gid": 0,
  "column_map": {"description": "Descrição", "quantity": "Qtd"},
  "format_version": 2,
  "rewrite_source_sheet": true,
  "translate": true,
  "translate_from": "pt",
  "translate_to": "ru",
  "translation_context_tokens": 30000,
  "disable_sparse_guard": false
}
```

## Настройки и нюансы
- `format_version` обязательно `2` для включения этого режима.
- `column_map` — те же ключи, что и в Формате 1 (`description`, `quantity`, `unit`, `unit_price`, `total_price`, `number`, `code`). Явная карта помогает избежать ошибок авто-детекта.
- `translate` можно выключить (`false`), тогда столбец “Перевод” будет пустым.
- `rewrite_source_sheet` по умолчанию включается, если целевая таблица совпадает с исходной и не создаётся новая; иначе создаётся лист `"<title> — Формат 2"`.
- `create_new_spreadsheet`/`target_spreadsheet_id` — если нужен вывод в отдельную таблицу.

## Sparse guard (защита от “слишком мало строк”)
- Гвард сравнивает количество собранных позиций с числом строк, где есть непустое описание (`description`). Если описаний ≥ 20 и позиций меньше ~половины, импорт останавливается с ошибкой “Распознано подозрительно мало строк (…)”.
- Перед ошибкой агент пытается восстановить mapping: авто-мэппинг, подбор самой “текстовой” колонки, перебор плотных колонок (`desc_scan:*`).
- Отключить можно через `disable_sparse_guard: true`, но это риск перезаписать лист неправильными данными.

## Выходные данные
- `sheets[0].url` — ссылка на созданный/перезаписанный лист.
- `rows` — сколько строк записано.
- При включённом переводе лог сохраняет предпросмотр переводов.***
